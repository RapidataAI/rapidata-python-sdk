"""MkDocs hook to boost search ranking for manually-written docs over auto-generated API reference."""

import re
from pathlib import Path


def on_page_read_source(page, config) -> str | None:
    """Inject search boost before MkDocs parses front matter.

    - Manual docs (not in reference/) get boosted (10x)
    - Auto-generated reference pages get demoted (0.2x)
    """
    page_path = page.file.src_path

    # Check if source file exists (auto-generated pages may not have one)
    src_file = Path(page.file.abs_src_path)
    if not src_file.exists():
        return None  # Let MkDocs handle auto-generated files differently

    # Read the source file
    with open(src_file, encoding="utf-8") as f:
        source = f.read()

    # Skip if page already has search config in front matter
    if source.startswith("---"):
        front_matter_match = re.match(r"^---\n(.*?)\n---", source, re.DOTALL)
        if front_matter_match and "search:" in front_matter_match.group(1):
            return None  # Don't modify

    # Auto-generated reference pages get demoted, manual docs get boosted
    if page_path.startswith("reference/"):
        boost_value = 0.2  # Demote API reference
    else:
        boost_value = 10  # Strongly boost manual docs

    # Inject front matter with search boost
    if source.startswith("---"):
        # Has existing front matter - inject search config after opening ---
        source = re.sub(
            r"^---\n",
            f"---\nsearch:\n  boost: {boost_value}\n",
            source,
            count=1
        )
    else:
        # No front matter - add it
        source = f"---\nsearch:\n  boost: {boost_value}\n---\n\n{source}"

    return source


def on_page_markdown(markdown: str, page, config, files) -> str | None:
    """Fallback for auto-generated pages that don't have source files.

    This handles reference/ pages generated by mkdocs-gen-files.
    """
    page_path = page.file.src_path

    # Only handle reference pages that weren't processed by on_page_read_source
    if not page_path.startswith("reference/"):
        return None

    # Check if already has search metadata
    if hasattr(page, 'meta') and page.meta.get('search', {}).get('boost') is not None:
        return None

    # Set the boost via page.meta directly for auto-generated pages
    if not hasattr(page, 'meta') or page.meta is None:
        page.meta = {}
    if 'search' not in page.meta:
        page.meta['search'] = {}
    page.meta['search']['boost'] = 0.2

    return None
