name: Deploy Documentation

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to deploy docs from'
        required: true
        default: 'main'
        type: choice
        options:
        - main
        - 2.x
      version_alias:
        description: 'Version alias for docs (e.g., 3.x, 2.x)'
        required: true
        default: '3.x'
        type: choice
        options:
        - 3.x
        - 2.x
      set_latest:
        description: 'Set this version as latest?'
        required: true
        default: true
        type: boolean

jobs:
  deploy-docs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch }}
          fetch-depth: 0
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH
      - name: Configure Git for mike
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
      - name: Update lock file and install dependencies
        run: |
          poetry lock
          poetry install --with docs
      - name: Deploy docs with mike
        run: |
          # Fetch gh-pages branch if it exists
          git fetch origin gh-pages:gh-pages || true

          # Deploy the version
          if [ "${{ github.event.inputs.set_latest }}" = "true" ]; then
            poetry run mike deploy --push --update-aliases ${{ github.event.inputs.version_alias }} latest
            poetry run mike set-default --push latest
          else
            poetry run mike deploy --push ${{ github.event.inputs.version_alias }}
          fi
      - name: Ensure CNAME exists
        run: |
          git checkout gh-pages
          if [ ! -f CNAME ]; then
            echo "docs.rapidata.ai" > CNAME
            git add CNAME
            git commit -m "Add CNAME file"
            git push origin gh-pages
          fi
          git checkout ${{ github.event.inputs.branch }}
