name: Release and Publish
on:
  workflow_dispatch:
    inputs:
      version_part:
        description: 'Version part to bump (none = just increment pre-release number)'
        required: true
        default: 'none'
        type: choice
        options:
        - none
        - patch
        - minor
        - major
      branch:
        description: 'Branch to release from (main, alpha, beta, rc, 2.x)'
        required: true
        default: 'main'
        type: string
jobs:
  release-and-publish:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        ref: ${{ github.event.inputs.branch }}
    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version-file: ".python-version"
    - name: Install uv
      uses: astral-sh/setup-uv@v7
    - name: Configure Git
      run: |
        git config user.name github-actions
        git config user.email github-actions@github.com

    - name: Determine release type
      id: release_type
      run: |
        branch="${{ github.event.inputs.branch }}"
        case "$branch" in
          alpha)  echo "type=alpha" >> $GITHUB_OUTPUT; echo "suffix=a" >> $GITHUB_OUTPUT ;;
          beta)   echo "type=beta" >> $GITHUB_OUTPUT; echo "suffix=b" >> $GITHUB_OUTPUT ;;
          rc)     echo "type=rc" >> $GITHUB_OUTPUT; echo "suffix=rc" >> $GITHUB_OUTPUT ;;
          *)      echo "type=stable" >> $GITHUB_OUTPUT; echo "suffix=" >> $GITHUB_OUTPUT ;;
        esac

    - name: Update version
      id: update_version
      run: |
        old_version=$(uv version --short)
        suffix="${{ steps.release_type.outputs.suffix }}"
        version_part="${{ github.event.inputs.version_part }}"

        if [ -n "$suffix" ]; then
          # Pre-release branch (alpha, beta, rc)

          if [ "$version_part" = "none" ]; then
            # Just increment pre-release number, keep base version
            # Extract base version (strip any existing pre-release suffix like a1, b2, rc3)
            base_version=$(echo "$old_version" | sed -E 's/(a|b|rc)[0-9]+$//')
          else
            # Bump the base version first
            uv version --bump $version_part
            base_version=$(uv version --short)
          fi

          # Find the latest pre-release number for this base version
          latest_num=$(git tag -l "v${base_version}${suffix}*" | \
            sed "s/v${base_version}${suffix}//" | \
            sort -n | tail -1)

          if [ -z "$latest_num" ]; then
            next_num=1
          else
            next_num=$((latest_num + 1))
          fi

          new_version="${base_version}${suffix}${next_num}"
          uv version "$new_version"
        else
          # Stable release: standard bump (none not allowed for stable)
          if [ "$version_part" = "none" ]; then
            echo "Error: 'none' is only valid for pre-release branches (alpha, beta, rc)"
            exit 1
          fi
          uv version --bump $version_part
          new_version=$(uv version --short)
        fi

        echo "new_version=$new_version" >> $GITHUB_OUTPUT
        echo "old_version=$old_version" >> $GITHUB_OUTPUT
    
    - name: Update version in Python code
      run: |
        python3 << 'EOF'
        import re
        import sys
        
        version = "${{ steps.update_version.outputs.new_version }}"
        
        # Update __init__.py
        init_file = "src/rapidata/__init__.py"
        try:
            with open(init_file, 'r') as f:
                content = f.read()
            
            # Replace __version__ = "..." with new version
            content = re.sub(r'__version__\s*=\s*["\'][^"\']*["\']', f'__version__ = "{version}"', content)
            
            with open(init_file, 'w') as f:
                f.write(content)
            print(f"Updated {init_file} with version {version}")
        except FileNotFoundError:
            print(f"File {init_file} not found, creating it...")
            with open(init_file, 'w') as f:
                f.write(f'__version__ = "{version}"\n')
        EOF
    
    - name: Commit and push changes
      run: |
        git add pyproject.toml src/rapidata/__init__.py
        git commit -m "Bump version from ${{ steps.update_version.outputs.old_version }} to ${{ steps.update_version.outputs.new_version }}"
        git push origin ${{ github.event.inputs.branch }}
    
    - name: Create and push tag
      run: |
        git tag v${{ steps.update_version.outputs.new_version }}
        git push origin v${{ steps.update_version.outputs.new_version }}
    
    - name: Build and publish
      env:
        PYPI_TOKEN: ${{ secrets.PYPI_TOKEN }}
      run: |
        uv build
        uv publish --token $PYPI_TOKEN
    - name: List dist contents
      run: ls -l dist/
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      continue-on-error: true
      with:
        tag_name: v${{ steps.update_version.outputs.new_version }}
        name: Release v${{ steps.update_version.outputs.new_version }}
        prerelease: ${{ steps.release_type.outputs.type != 'stable' }}
        files: |
          dist/*.whl
          dist/*.tar.gz
